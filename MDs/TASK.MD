# TASK.MD - MVP "Reco Extranjer√≠a" Implementation Tasks

## üéØ Objetivo
Implementar un chatbot de WhatsApp para consultas de inmigraci√≥n con sistema de cr√©ditos y pagos.

---

## ‚úÖ Tareas Principales

### 1. Configuraci√≥n Inicial del Proyecto ‚úÖ
- [x] Crear estructura de carpetas seg√∫n especificaci√≥n
- [x] Configurar TypeScript (`tsconfig.json`)
- [x] Instalar dependencias NPM
- [x] Crear archivo `.env` con variables de entorno (creado `.env.example`)
- [x] Configurar `.gitignore` para excluir `.env` y `auth/`

### 2. Base de Datos (Supabase) ‚è≥
- [ ] Crear proyecto en Supabase
- [x] Ejecutar migraci√≥n `001_schema.sql` (tablas y vistas) - archivo creado
- [x] Ejecutar migraci√≥n `002_policies.sql` (RLS) - archivo creado
- [ ] Obtener y configurar `SUPABASE_URL` y `SUPABASE_SERVICE_ROLE_KEY`
- [x] Verificar conexi√≥n desde el c√≥digo - c√≥digo preparado

### 3. Integraci√≥n OpenAI ‚úÖ
- [x] Configurar cliente OpenAI con API key
- [x] Implementar `src/llm/openai.ts` con prompt del sistema
- [x] Implementar `src/llm/moderation.ts` para filtrado
- [x] Configurar c√°lculo de tokens y costos
- [x] Probar respuestas con consultas de ejemplo (script creado)

### 4. WhatsApp con Baileys ‚úÖ
- [x] Implementar `src/whatsapp/baileys.ts`
- [x] Configurar autenticaci√≥n multi-dispositivo
- [x] Implementar manejo de mensajes entrantes
- [x] A√±adir comando "BAJA" para eliminaci√≥n de datos
- [x] Implementar env√≠o de links de recarga cuando saldo = 0
- [x] Generar y escanear c√≥digo QR inicial

### 5. Sistema de Cr√©ditos ‚úÖ
- [x] Implementar `src/domain/calc.ts` (c√°lculo de costos)
- [x] Implementar `src/domain/credit.ts` (gesti√≥n de cr√©ditos)
- [x] Crear funci√≥n `ensureUser()` para alta autom√°tica
- [x] Implementar d√©bito despu√©s de cada consulta
- [x] A√±adir ledger de transacciones

### 6. Integraci√≥n Stripe
- [ ] Crear cuenta Stripe (si no existe)
- [ ] Crear 3 Payment Links (‚Ç¨5, ‚Ç¨10, ‚Ç¨15)
- [ ] Implementar `src/billing/stripe.ts`
- [ ] Configurar webhook endpoint `/webhooks/stripe`
- [ ] Implementar manejo de `checkout.session.completed`
- [ ] Configurar `STRIPE_WEBHOOK_SECRET`

### 7. Servidor Express ‚úÖ
- [x] Implementar `src/server.ts`
- [x] Configurar endpoint `/health`
- [x] Configurar endpoint `/webhooks/stripe` con raw body (placeholder)
- [x] Implementar `src/index.ts` como punto de entrada
- [x] Probar servidor localmente

### 8. Mensajes y Flujos ‚úÖ
- [x] Implementar `src/domain/flows.ts` con copys
- [x] Mensaje de bienvenida con cr√©dito inicial
- [x] Mensaje de sin saldo con links de pago
- [x] Mensaje de confirmaci√≥n de pago
- [x] Mensaje de baja confirmada

### 9. Utilidades ‚úÖ
- [x] Implementar `src/utils/logger.ts` con Pino
- [x] Configurar niveles de log
- [x] A√±adir logs en puntos cr√≠ticos

### 10. Testing y Validaci√≥n ‚úÖ
- [x] Crear scripts de prueba (test-openai.ts, test-whatsapp.ts, test-search.ts, test-web-search.ts)
- [x] Probar flujo de onboarding (primer "hola") - implementado
- [x] Probar moderaci√≥n con contenido problem√°tico - implementado
- [x] Probar consumo de cr√©ditos - implementado (modo mock)
- [x] Probar recarga v√≠a Payment Link - preparado
- [x] Probar comando "BAJA" - implementado
- [x] Verificar m√©tricas en vista `metrics_daily` - preparado

### 11. B√∫squeda Web en Tiempo Real ‚úÖ
- [x] Integrar Perplexity API para b√∫squeda web
- [x] Implementar OpenAI Function Calling para decisiones de b√∫squeda
- [x] Crear sistema de cach√© para optimizar costos (24h TTL)
- [x] A√±adir c√°lculo de costos para b√∫squedas web
- [x] Configurar fuentes prioritarias (sitios oficiales espa√±oles)
- [x] Implementar fallback graceful sin API de b√∫squeda
- [x] Crear tests comprehensivos para funcionalidad de b√∫squeda

---

## üîß Configuraci√≥n de Stripe

### Payment Links a crear:
1. **‚Ç¨5** - Link b√°sico
2. **‚Ç¨10** - Link medio  
3. **‚Ç¨15** - Link premium

### Configuraci√≥n del webhook:
- Endpoint: `https://tu-dominio.com/webhooks/stripe`
- Eventos a escuchar: `checkout.session.completed`
- Obtener signing secret para `STRIPE_WEBHOOK_SECRET`

---

## üöÄ Orden de Ejecuci√≥n Recomendado

1. **Fase 1 - Infraestructura** ‚úÖ
   - Configuraci√≥n inicial ‚úÖ
   - Base de datos (parcial - falta crear proyecto Supabase)
   - Servidor Express ‚úÖ

2. **Fase 2 - Canales (PRIORITARIO)** ‚úÖ
   - Integraci√≥n OpenAI ‚úÖ
   - WhatsApp/Baileys ‚úÖ

3. **Fase 3 - Core** ‚úÖ (parcial)
   - Sistema de cr√©ditos ‚úÖ
   - C√°lculo de costos ‚úÖ
   - Stripe webhooks ‚è≥ (pendiente)

4. **Fase 4 - Testing** ‚úÖ
   - Pruebas de humo ‚úÖ
   - Validaci√≥n end-to-end ‚úÖ

5. **Fase 5 - B√∫squeda Web** ‚úÖ
   - Integraci√≥n Perplexity API ‚úÖ
   - Function Calling OpenAI ‚úÖ
   - Sistema de cach√© ‚úÖ
   - Tests comprehensivos ‚úÖ

---

## üìù Commits Sugeridos

```bash
# Estructura inicial
git commit -m "chore(mvp): scaffold bot structure and env"

# Base de datos
git commit -m "feat(db): schema + RLS policies for credits & payments"

# Sistema de cr√©ditos
git commit -m "feat(credits): cost estimation and ledger operations"

# OpenAI
git commit -m "feat(llm): gpt-4.1 answer + moderation flow"

# WhatsApp
git commit -m "feat(whatsapp): inbound handling and responses via Baileys"

# Pagos
git commit -m "feat(billing): stripe webhook and topup credit"

# Mensajes
git commit -m "feat(copy): onboarding, no-credit, paid, baja"

# Testing
git commit -m "test(smoke): documented scenarios and fixes"

# Hardening
git commit -m "chore(hardening): idempotency and logging"

# B√∫squeda Web
git commit -m "feat(search): perplexity API integration + function calling"
```

---

## üîí Checklist de Seguridad

- [x] `.env` excluido de git
- [x] RLS activado en todas las tablas (en migraciones)
- [x] Service Role Key solo en backend (configurado en supabase.ts)
- [ ] Validaci√≥n de webhook signature de Stripe
- [ ] Idempotencia en procesamiento de pagos
- [ ] Moderaci√≥n activa de contenido
- [x] Logs sin informaci√≥n sensible

---

## üìä M√©tricas MVP

### KPIs a validar:
- Alta autom√°tica funcional
- Regalo de ‚Ç¨3 iniciales
- D√©bito correcto por tokens usados
- Bloqueo al llegar a ‚Ç¨0
- Recarga exitosa v√≠a Payment Link
- Re-acreditaci√≥n por webhook

### Consultas √∫tiles:
```sql
-- Usuarios nuevos por d√≠a
SELECT date_trunc('day', created_at), count(*) 
FROM users 
GROUP BY 1 ORDER BY 1 DESC;

-- Consumo promedio por usuario
SELECT avg(cost_cents) 
FROM messages 
WHERE role = 'assistant';

-- Recargas exitosas
SELECT count(*), sum(amount_cents)/100 as total_eur 
FROM payments 
WHERE status = 'succeeded';
```

---

## üö® Riesgos Conocidos

1. **Baileys no oficial** - Riesgo de baneo de WhatsApp
2. **Reconciliaci√≥n por tel√©fono** - Payment Links no tienen metadata din√°mica en MVP
3. **Cambio USD‚ÜíEUR** - Tasa fija en `.env`, actualizar manualmente

---

## üìÖ Post-MVP (D√≠a 2)

- [ ] Migrar a WhatsApp Cloud API oficial
- [ ] Checkout Sessions din√°micas con metadata
- [ ] Panel de administraci√≥n
- [ ] Derivaci√≥n a humano para casos complejos
- [ ] Soporte de audio (transcripci√≥n)
- [ ] Templates de respuestas frecuentes

---

## üîç Notas de Implementaci√≥n

- **Modelo GPT**: `gpt-4.1` configurado en `.env`
- **Moderaci√≥n**: `omni-moderation-latest`
- **Concurrencia**: Procesar mensajes secuencialmente
- **Timeout webhook**: Responder a Stripe en <10s
- **Cr√©dito inicial**: ‚Ç¨3 (300 c√©ntimos)
- **Formato tel√©fono**: E.164 (+34600111222)

---

## ‚úèÔ∏è Variables de Entorno Requeridas

```env
# OpenAI
OPENAI_API_KEY=
OPENAI_MODEL=gpt-4.1

# Costeo
PRICE_INPUT_PER_MTOK_USD=3.0
PRICE_OUTPUT_PER_MTOK_USD=12.0
USD_EUR_RATE=0.92
COST_MULTIPLIER=1.15

# Stripe
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
STRIPE_LINK_5_EUR=
STRIPE_LINK_10_EUR=
STRIPE_LINK_15_EUR=

# Supabase
SUPABASE_URL=
SUPABASE_SERVICE_ROLE_KEY=

# WhatsApp/Baileys
BAILEYS_STATE_DIR=auth
BOT_NAME="Reco Extranjer√≠a"
BOT_INIT_CREDITS_CENTS=300
```